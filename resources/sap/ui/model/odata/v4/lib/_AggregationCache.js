/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_ConcatHelper","./_GroupLock","./_Helper","./_MinMaxHelper","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,n,r,i,o,a,s){"use strict";function l(r,o,a,l,u){var d=function(){},h=null,c,p=this;t.call(this,r,o,l,true);this.oAggregation=a;this.sDownloadUrl=t.prototype.getDownloadUrl.call(this,"");this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.oCountPromise=undefined;if(l.$count){if(a.hierarchyQualifier){this.oCountPromise=new s(function(e){c=e});this.oCountPromise.$resolve=c}else if(a.groupLevels.length){l.$$leaves=true;this.oCountPromise=new s(function(e){h=function(t){e(parseInt(t.UI5__leaves))}})}}this.oFirstLevel=this.createGroupLevelCache(null,u||!!h);this.addKeptElement=this.oFirstLevel.addKeptElement;this.removeKeptElement=this.oFirstLevel.removeKeptElement;this.requestSideEffects=this.oFirstLevel.requestSideEffects;this.oGrandTotalPromise=undefined;if(u){this.oGrandTotalPromise=new s(function(t){n.enhanceCache(p.oFirstLevel,a,[h,function(n){var r;if(a["grandTotal like 1.84"]){e.removeUI5grand__(n)}e.setAnnotations(n,true,true,0,e.getAllProperties(a));if(a.grandTotalAtBottomOnly===false){r=Object.assign({},n,{"@$ui5.node.isExpanded":undefined});i.setPrivateAnnotation(n,"copy",r);i.setPrivateAnnotation(r,"predicate","($isTotal=true)")}i.setPrivateAnnotation(n,"predicate","()");t(n)},d])})}else if(h){n.enhanceCache(p.oFirstLevel,a,[h,d])}}l.prototype=Object.create(t.prototype);l.prototype.addTransientCollection=null;l.prototype.getAndRemoveValue=null;l.prototype._delete=function(e,t,n,r,o){if(this.oAggregation.expandTo>1){throw new Error("Unsupported expandTo: "+this.oAggregation.expandTo)}let a=parseInt(n);if(isNaN(a)){throw new Error(`Unsupported kept-alive entity: ${this.sResourcePath}${n}`)}const s=this.aElements[a];const l=i.getPrivateAnnotation(s,"parent");const u=i.getPrivateAnnotation(s,"index");let d=a-u-1;const h=this.aElements[d];return l._delete(e,t,u.toString(),r,(e,t)=>{if(t<0){this.shiftIndex(a,t);this.removeElement(this.aElements,a,i.getPrivateAnnotation(s,"predicate"),"");if(h&&!l.getValue("$count")){i.updateAll(this.mChangeListeners,i.getPrivateAnnotation(h,"predicate"),h,{"@$ui5.node.isExpanded":undefined});delete h["@$ui5.node.isExpanded"]}}else{if(h){if(h!==this.aElements[d]){d=this.aElements.indexOf(h)}if(l.getValue("$count")===1){i.updateAll(this.mChangeListeners,i.getPrivateAnnotation(h,"predicate"),h,{"@$ui5.node.isExpanded":true})}}a=d+e+1;this.restoreElement(this.aElements,a,s,"");this.shiftIndex(a,t)}o(a,t)})};l.prototype.addElements=function(t,n,r,o){var a=this.aElements,l=this.oAggregation.hierarchyQualifier,u=this.oAggregation.$NodeProperty,d=this;function h(t,h){var c=a[n+h],p,f=i.getPrivateAnnotation(t,"transientPredicate")||i.getPrivateAnnotation(t,"predicate");if(c){if(c===t){return}e.beforeOverwritePlaceholder(c,t,r,o+h,u)}else if(n+h>=a.length){throw new Error("Array index out of bounds: "+(n+h))}p=a.$byPredicate[f];if(p&&p!==t&&!(p instanceof s)){if(!l){throw new Error("Duplicate predicate: "+f)}if(!p["@odata.etag"]||t["@odata.etag"]===p["@odata.etag"]){i.updateNonExisting(t,p)}else if(d.hasPendingChangesForPath(f)){throw new Error("Modified on client and on server: "+d.sResourcePath+f)}}a.$byPredicate[f]=a[n+h]=t;if(r){i.setPrivateAnnotation(t,"index",o+h);i.setPrivateAnnotation(t,"parent",r)}}if(n<0){throw new Error("Illegal offset: "+n)}if(Array.isArray(t)){t.forEach(h)}else{h(t,0)}};l.prototype.beforeRequestSideEffects=function(e){if(!this.oAggregation.hierarchyQualifier){throw new Error("Missing recursive hierarchy")}delete e.$apply;if(!e.$select.includes(this.oAggregation.$NodeProperty)){e.$select.push(this.oAggregation.$NodeProperty)}};l.prototype.beforeUpdateSelected=function(t,n){e.checkNodeProperty(this.aElements.$byPredicate[t],n,this.oAggregation.$NodeProperty,true)};l.prototype.collapse=function(t){var n,r=0,o,a=this.aElements,s=this.getValue(t),l=s["@$ui5.node.level"],u=a.indexOf(s),d=u+1;function h(e){delete a.$byPredicate[i.getPrivateAnnotation(a[e],"predicate")];r+=1}n=e.getCollapsedObject(s);i.updateAll(this.mChangeListeners,t,s,n);o=i.getPrivateAnnotation(s,"descendants");if(o){l=this.oAggregation.expandTo}while(d<a.length){if(a[d]["@$ui5.node.level"]<=l){if(!o){break}o-=1;if(a[d]["@$ui5.node.isExpanded"]===false){o-=i.getPrivateAnnotation(a[d],"descendants")||0}}h(d);d+=1}if(this.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(n).length>1){h(d)}i.setPrivateAnnotation(s,"spliced",a.splice(u+1,r));a.$count-=r;return r};l.prototype.create=function(e,t,n,r,o,a,s,l){if(this.oAggregation.expandTo>1){throw new Error("Unsupported expandTo: "+this.oAggregation.expandTo)}if(a){throw new Error("Unsupported bAtEndOfCreated")}const u=this.aElements;const d=o["@$ui5.node.parent"];const h=d.slice(d.indexOf("("));const c=u.$byPredicate[h];if(c["@$ui5.node.isExpanded"]===false){throw new Error("Unsupported collapsed parent: "+d)}const p=u.indexOf(c)+1;let f=i.getPrivateAnnotation(c,"cache");if(!f){f=this.createGroupLevelCache(c);f.setEmpty();i.setPrivateAnnotation(c,"cache",f);i.updateAll(this.mChangeListeners,h,c,{"@$ui5.node.isExpanded":true})}delete o["@$ui5.node.parent"];const g=f.create(e,t,n,r,o,a,s,l,function e(){this.shiftIndex(p,-1);u.$count-=1;delete u.$byPredicate[i.getPrivateAnnotation(o,"transientPredicate")];u.splice(u.indexOf(o),1)}.bind(this));i.getPrivateAnnotation(o,"postBody")[this.oAggregation.$ParentNavigationProperty+"@odata.bind"]=i.makeRelativeUrl("/"+d,"/"+this.sResourcePath);o["@$ui5.node.level"]=c["@$ui5.node.level"]+1;u.splice(p,0,null);this.addElements(o,p,f,0);u.$count+=1;this.shiftIndex(p,+1);return g.then(function(){u.$byPredicate[i.getPrivateAnnotation(o,"predicate")]=o;return o})};l.prototype.createGroupLevelCache=function(n,r){var o=this.oAggregation,a=n?n["@$ui5.node.level"]+1:1,s,u,d,h,c,p;if(o.hierarchyQualifier){c=Object.assign({},this.mQueryOptions)}else{s=e.getAllProperties(o);h=a>o.groupLevels.length;d=h?o.groupLevels.concat(Object.keys(o.group).sort()):o.groupLevels.slice(0,a);c=e.filterOrderby(this.mQueryOptions,o,a);p=!h&&Object.keys(o.aggregate).some(function(e){return o.aggregate[e].subtotals})}if(n){c.$$filterBeforeAggregate=i.getPrivateAnnotation(n,"filter")+(c.$$filterBeforeAggregate?" and ("+c.$$filterBeforeAggregate+")":"")}if(!r){delete c.$count;c=e.buildApply(o,c,a)}c.$count=true;u=t.create(this.oRequestor,this.sResourcePath,c,true);u.calculateKeyPredicate=o.hierarchyQualifier?l.calculateKeyPredicateRH.bind(null,n,o):l.calculateKeyPredicate.bind(null,n,d,s,h,p);return u};l.prototype.expand=function(t,n,o){var a,l,u=this.aElements,d=typeof n==="string"?this.getValue(n):n,h,c=i.getPrivateAnnotation(d,"spliced"),p,f=this;if(n!==d){i.updateAll(this.mChangeListeners,n,d,e.getOrCreateExpandedObject(this.oAggregation,d))}if(c){i.deletePrivateAnnotation(d,"spliced");p=c.$stale;h=u.indexOf(d)+1;this.aElements=u.concat(c,u.splice(h));this.aElements.$byPredicate=u.$byPredicate;l=c.length;this.aElements.$count=u.$count+l;c.forEach(function(e){var t=i.getPrivateAnnotation(e,"predicate");if(!i.hasPrivateAnnotation(e,"placeholder")){if(p){f.turnIntoPlaceholder(e,t)}else{f.aElements.$byPredicate[t]=e;if(i.hasPrivateAnnotation(e,"expanding")){i.deletePrivateAnnotation(e,"expanding");l+=f.expand(r.$cached,e).getResult()}}}});return s.resolve(l)}a=i.getPrivateAnnotation(d,"cache");if(!a){a=this.createGroupLevelCache(d);i.setPrivateAnnotation(d,"cache",a)}return a.read(0,this.iReadLength,0,t,o).then(function(t){var r=f.aElements.indexOf(d)+1,o=d["@$ui5.node.level"],s=e.getCollapsedObject(d),u=f.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(s).length>1,h;if(!d["@$ui5.node.isExpanded"]){i.deletePrivateAnnotation(d,"spliced");return 0}if(!r){i.setPrivateAnnotation(d,"expanding",true);return 0}l=t.value.$count;if(i.hasPrivateAnnotation(d,"groupLevelCount")&&i.getPrivateAnnotation(d,"groupLevelCount")!==l){throw new Error("Unexpected structural change: groupLevelCount")}i.setPrivateAnnotation(d,"groupLevelCount",l);i.updateAll(f.mChangeListeners,n,d,{"@$ui5.node.groupLevelCount":l});if(u){l+=1}if(r===f.aElements.length){f.aElements.length+=l}else{for(h=f.aElements.length-1;h>=r;h-=1){f.aElements[h+l]=f.aElements[h];delete f.aElements[h]}}f.addElements(t.value,r,a,0);for(h=r+t.value.length;h<r+t.value.$count;h+=1){f.aElements[h]=e.createPlaceholder(o+1,h-r,a)}if(u){s=Object.assign({},s);e.setAnnotations(s,undefined,true,o,e.getAllProperties(f.oAggregation));i.setPrivateAnnotation(s,"predicate",i.getPrivateAnnotation(d,"predicate").slice(0,-1)+",$isTotal=true)");f.addElements(s,r+l-1)}f.aElements.$count+=l;return l},function(t){i.updateAll(f.mChangeListeners,n,d,e.getCollapsedObject(d));throw t})};l.prototype.fetchValue=function(e,t,n,r){var i=this;if(t==="$count"){if(this.oCountPromise){return this.oCountPromise}if(this.oAggregation.hierarchyQualifier||this.oAggregation.groupLevels.length){a.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return s.resolve()}return this.oFirstLevel.fetchValue(e,t,n,r)}return s.resolve(this.aElements.$byPredicate[t.split("/")[0]]).then(function(){i.registerChangeListener(t,r);return i.drillDown(i.aElements,t,e)})};l.prototype.getAllElements=function(e){var t;if(e){throw new Error("Unsupported path: "+e)}t=this.aElements.map(function(e){return i.hasPrivateAnnotation(e,"placeholder")?undefined:e});t.$count=this.aElements.$count;return t};l.prototype.getCreatedElements=function(e){return[]};l.prototype.getDownloadQueryOptions=function(t){if(this.oAggregation.hierarchyQualifier){if("$count"in t){t=Object.assign({},t);delete t.$count}}else{t=e.filterOrderby(t,this.oAggregation)}return e.buildApply(this.oAggregation,t,0,true)};l.prototype.getDownloadUrl=function(e,t){return this.sDownloadUrl};l.prototype.getValue=function(e){var t;t=this.fetchValue(r.$cached,e);if(t.isFulfilled()){return t.getResult()}t.caught()};l.prototype.isDeletingInOtherGroup=function(e){return false};l.prototype.keepOnlyGivenElements=function(t){var n={},r=this;t.forEach(function(e){n[e]=true});return this.aElements.filter(function(t){var o=i.getPrivateAnnotation(t,"predicate");if(n[o]){e.markSplicedStale(t);return true}r.turnIntoPlaceholder(t,o)})};l.prototype.read=function(e,t,n,r,o){var a,l,u=e,d=t,h,c,p=this.oGrandTotalPromise&&this.oAggregation.grandTotalAtBottomOnly!==true,f=[],g,v,m=this;function P(e,t){f.push(m.readGap(h,e,t,r.getUnlockedCopy(),o))}if(p&&!e&&t===1){if(n!==0){throw new Error("Unsupported prefetch length: "+n)}r.unlock();return this.oGrandTotalPromise.then(function(e){return{value:[e]}})}if(this.aElements.$count===undefined){this.iReadLength=t+n;if(p){if(u){u-=1}else{d-=1}}f.push(this.readCount(r),this.readFirst(u,d,n,r,o))}else{for(g=e,v=Math.min(e+t,this.aElements.length);g<v;g+=1){l=this.aElements[g];a=i.hasPrivateAnnotation(l,"placeholder")?i.getPrivateAnnotation(l,"parent"):undefined;if(a!==h){if(c!==undefined){P(c,g);h=c=undefined}if(a){c=g;h=a}}else if(c!==undefined&&i.getPrivateAnnotation(l,"index")!==i.getPrivateAnnotation(this.aElements[g-1],"index")+1){P(c,g);c=g}}if(c!==undefined){P(c,g)}r.unlock()}return s.all(f).then(function(){var n=m.aElements.slice(e,e+t).map(function(e){return i.hasPrivateAnnotation(e,"placeholder")?undefined:e});n.$count=m.aElements.$count;return{value:n}})};l.prototype.readCount=function(e){var t,n=this.oCountPromise&&this.oCountPromise.$resolve,r;if(n){delete this.oCountPromise.$resolve;t=Object.assign({},this.mQueryOptions);delete t.$apply;delete t.$count;delete t.$expand;delete t.$orderby;if(this.oAggregation.search){t.$search=this.oAggregation.search}delete t.$select;r=this.sResourcePath+"/$count"+this.oRequestor.buildQueryString(null,t);return this.oRequestor.request("GET",r,e.getUnlockedCopy()).then(n)}};l.prototype.readFirst=function(t,n,r,o,a){var s=this;return this.oFirstLevel.read(t,n,r,o,a).then(function(n){var r,o,a=0,l;s.aElements.length=s.aElements.$count=n.value.$count;if(s.oGrandTotalPromise){s.aElements.$count+=1;s.aElements.length+=1;r=s.oGrandTotalPromise.getResult();switch(s.oAggregation.grandTotalAtBottomOnly){case false:a=1;s.aElements.$count+=1;s.aElements.length+=1;s.addElements(r,0);o=i.getPrivateAnnotation(r,"copy");s.addElements(o,s.aElements.length-1);break;case true:s.addElements(r,s.aElements.length-1);break;default:a=1;s.addElements(r,0)}}s.addElements(n.value,t+a,s.oFirstLevel,t);for(l=0;l<s.aElements.$count;l+=1){if(!s.aElements[l]){s.aElements[l]=e.createPlaceholder(s.oAggregation.expandTo>1?0:1,l-a,s.oFirstLevel)}}})};l.prototype.readGap=function(e,t,n,r,o){var a,s,l=e.getQueryOptions(),u=i.getPrivateAnnotation(this.aElements[t],"index"),d=this.aElements[t],h,c=this;if(l.$count){delete l.$count;e.setQueryOptions(l,true)}s=e.read(u,n-t,0,r,o).then(function(n){var r=false,i;if(d!==c.aElements[t]&&n.value[0]!==c.aElements[t]){r=true;t=c.aElements.indexOf(d);if(t<0){t=c.aElements.indexOf(n.value[0]);if(t<0){i=new Error("Collapse before read has finished");i.canceled=true;throw i}}}c.addElements(n.value,t,e,u);if(r){i=new Error("Collapse or expand before read has finished");i.canceled=true;throw i}});if(s.isPending()){for(h=t;h<n;h+=1){a=i.getPrivateAnnotation(this.aElements[h],"predicate");if(a){this.aElements.$byPredicate[a]=s}}}return s};l.prototype.refreshKeptElements=function(e,t){return this.oFirstLevel.refreshKeptElements.call(this,e,t,true)};l.prototype.reset=function(e,n,r,o,a){var l,u=this;if(a){throw new Error("Unsupported grouping via sorter")}e.forEach(function(e){var t=u.aElements.$byPredicate[e];if(i.hasPrivateAnnotation(t,"placeholder")){throw new Error("Unexpected placeholder")}delete t["@$ui5.node.isExpanded"];delete t["@$ui5.node.level"];delete t["@$ui5._"];i.setPrivateAnnotation(t,"predicate",e)});this.oAggregation=o;this.sDownloadUrl=t.prototype.getDownloadUrl.call(this,"");this.oFirstLevel.reset.call(this,e,n,r);if(n){this.oBackup.oCountPromise=this.oCountPromise;this.oBackup.oFirstLevel=this.oFirstLevel}this.oCountPromise=undefined;if(r.$count){this.oCountPromise=new s(function(e){l=e});this.oCountPromise.$resolve=l}this.oFirstLevel=this.createGroupLevelCache()};l.prototype.resetChangesForPath=function(e){i.getPrivateAnnotation(this.getValue(e),"parent").resetChangesForPath(e)};l.prototype.restore=function(e){if(e){this.oCountPromise=this.oBackup.oCountPromise;this.oFirstLevel=this.oBackup.oFirstLevel}this.oFirstLevel.restore.call(this,e)};l.prototype.shiftIndex=function(e,t){const n=this.aElements;const r=n[e];const o=i.getPrivateAnnotation(r,"parent");for(let a=e+1;a<n.length;a+=1){const e=n[a];if(i.getPrivateAnnotation(e,"parent")===o){i.setPrivateAnnotation(e,"index",i.getPrivateAnnotation(e,"index")+t)}if(e["@$ui5.node.level"]<r["@$ui5.node.level"]&&!i.hasPrivateAnnotation(e,"placeholder")){break}}};l.prototype.toString=function(){return this.sDownloadUrl};l.prototype.turnIntoPlaceholder=function(t,n){if(i.hasPrivateAnnotation(t,"placeholder")){return}i.setPrivateAnnotation(t,"placeholder",1);e.markSplicedStale(t);delete this.aElements.$byPredicate[n];i.getPrivateAnnotation(t,"parent").drop(i.getPrivateAnnotation(t,"index"),n)};l.calculateKeyPredicate=function(t,n,r,o,a,s,l,u){var d;if(!(u in l)){return undefined}if(t){r.forEach(function(e){if(Array.isArray(e)){i.inheritPathValue(e,t,s)}else if(!(e in s)){s[e]=t[e]}})}d=o&&i.getKeyPredicate(s,u,l)||i.getKeyPredicate(s,u,l,n,true);i.setPrivateAnnotation(s,"predicate",d);if(!o){i.setPrivateAnnotation(s,"filter",i.getKeyFilter(s,u,l,n))}e.setAnnotations(s,o?undefined:false,a,t?t["@$ui5.node.level"]+1:1,t?null:r);return d};l.calculateKeyPredicateRH=function(t,n,r,o,a){var s,l,u=1,d,h;if(!(a in o)){return undefined}h=i.getKeyPredicate(r,a,o);i.setPrivateAnnotation(r,"predicate",h);if(a!==n.$metaPath){return h}switch(i.drillDown(r,n.$DrillStateProperty)){case"expanded":l=true;break;case"collapsed":l=false;i.setPrivateAnnotation(r,"filter",i.getKeyFilter(r,a,o));break;default:}i.deleteProperty(r,n.$DrillStateProperty);if(t){u=t["@$ui5.node.level"]+1}else{s=i.drillDown(r,n.$DistanceFromRootProperty);if(s){i.deleteProperty(r,n.$DistanceFromRootProperty);u=parseInt(s)+1}}e.setAnnotations(r,l,undefined,u);if(n.$LimitedDescendantCountProperty){d=i.drillDown(r,n.$LimitedDescendantCountProperty);if(d){i.deleteProperty(r,n.$LimitedDescendantCountProperty);if(d!=="0"){i.setPrivateAnnotation(r,"descendants",parseInt(d))}}}return h};l.create=function(n,r,i,a,s,u,d,h){var c,p;function f(){if("$expand"in a){throw new Error("Unsupported system query option: $expand")}if("$select"in a){throw new Error("Unsupported system query option: $select")}}if(s){c=e.hasGrandTotal(s.aggregate);p=s.groupLevels&&!!s.groupLevels.length;if(e.hasMinOrMax(s.aggregate)){if(c){throw new Error("Unsupported grand totals together with min/max")}if(p){throw new Error("Unsupported group levels together with min/max")}if(s.hierarchyQualifier){throw new Error("Unsupported recursive hierarchy together with min/max")}if(d){throw new Error("Unsupported $$sharedRequest together with min/max")}f();return o.createCache(n,r,s,a)}if(a.$filter&&(c&&!s["grandTotal like 1.84"]||p)){throw new Error("Unsupported system query option: $filter")}if(c||p||s.hierarchyQualifier){if(a.$search){throw new Error("Unsupported system query option: $search")}if(!s.hierarchyQualifier){f()}if(h){throw new Error("Unsupported grouping via sorter")}if(d){throw new Error("Unsupported $$sharedRequest")}return new l(n,r,s,a,c)}}if(a.$$filterBeforeAggregate){a.$apply="filter("+a.$$filterBeforeAggregate+")/"+a.$apply;delete a.$$filterBeforeAggregate}return t.create(n,r,a,u,i,d)};return l},false);
//# sourceMappingURL=_AggregationCache.js.map